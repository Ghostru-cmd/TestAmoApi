<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="./style.css">
    <title>Document</title>
</head>
<body>

	<div class="mainDiv">
		<div class="header">
			<h2 class="headerText">Тестовое задание</h2>
			<input type="text" class="search" placeholder="Search..."><svg viewBox="64 64 896 896" data-icon="search" width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class="searchSvg"><path d="M909.6 854.5L649.9 594.8C690.2 542.7 712 479 712 412c0-80.2-31.3-155.4-87.9-212.1-56.6-56.7-132-87.9-212.1-87.9s-155.5 31.3-212.1 87.9C143.2 256.5 112 331.8 112 412c0 80.1 31.3 155.5 87.9 212.1C256.5 680.8 331.8 712 412 712c67 0 130.6-21.8 182.7-62l259.7 259.6a8.2 8.2 0 0 0 11.6 0l43.6-43.5a8.2 8.2 0 0 0 0-11.6zM570.4 570.4C528 612.7 471.8 636 412 636s-116-23.3-158.4-65.6C211.3 528 188 471.8 188 412s23.3-116.1 65.6-158.4C296 211.3 352.2 188 412 188s116.1 23.2 158.4 65.6S636 352.2 636 412s-23.3 116.1-65.6 158.4z"></path></svg>
		</div>
		<div class="table">
			<table class="tableBody">
				<thead>
					<tr>
						<th>Название</th>
						<th>Статус</th>
						<th>Отвецтвенный</th>
						<th>Дата создания</th>
						<th>Бюджет</th>
					</tr>
				</thead>
				<tbody class="tbody">

				</tbody>
			</table>
		</div>
	</div>

    <script>



		(async () => {
			const responseLeads = await fetch('http://localhost:5000/leads')
			const leads = await responseLeads.json()
			// const leads = [
			// 						{
			// 							id: 1593553,
			// 							name: 'Запрос тарифов',
			// 							price: 14000,
			// 							responsible_user_id: 6766063,
			// 							group_id: 0,
			// 							status_id: 38046913,
			// 							pipeline_id: 3998857,
			// 							loss_reason_id: null,
			// 							created_by: 6766063,
			// 							updated_by: 6766063,
			// 							created_at: 1613652307,
			// 							updated_at: 1613652307,
			// 							closed_at: null,
			// 							closest_task_at: null,
			// 							is_deleted: false,
			// 							custom_fields_values: null,
			// 							score: null,
			// 							account_id: 29305399,
			// 							_links: { self: [Object] },
			// 							_embedded: { tags: [], companies: [] }
			// 						},
			// 						{
			// 							id: 1593595,
			// 							name: 'Рекламная продукция',
			// 							price: 11000,
			// 							responsible_user_id: 6766063,
			// 							group_id: 0,
			// 							status_id: 38046913,
			// 							pipeline_id: 3998857,
			// 							loss_reason_id: null,
			// 							created_by: 6766063,
			// 							updated_by: 6766063,
			// 							created_at: 1613652354,
			// 							updated_at: 1613652354,
			// 							closed_at: null,
			// 							closest_task_at: null,
			// 							is_deleted: false,
			// 							custom_fields_values: null,
			// 							score: null,
			// 							account_id: 29305399,
			// 							_links: { self: [Object] },
			// 							_embedded: { tags: [], companies: [] }
			// 						},
			// 						{
			// 							id: 1593637,
			// 							name: 'Настройка аккаунта',
			// 							price: 350000,
			// 							responsible_user_id: 6766063,
			// 							group_id: 0,
			// 							status_id: 38046913,
			// 							pipeline_id: 3998857,
			// 							loss_reason_id: null,
			// 							created_by: 6766063,
			// 							updated_by: 6766063,
			// 							created_at: 1613652416,
			// 							updated_at: 1613652416,
			// 							closed_at: null,
			// 							closest_task_at: null,
			// 							is_deleted: false,
			// 							custom_fields_values: null,
			// 							score: null,
			// 							account_id: 29305399,
			// 							_links: { self: [Object] },
			// 							_embedded: { tags: [], companies: [] }
			// 						},
			// 						{
			// 							id: 1593735,
			// 							name: 'Запрос тарифов',
			// 							price: 356000,
			// 							responsible_user_id: 6766063,
			// 							group_id: 0,
			// 							status_id: 38046913,
			// 							pipeline_id: 3998857,
			// 							loss_reason_id: null,
			// 							created_by: 6766063,
			// 							updated_by: 6766063,
			// 							created_at: 1613652517,
			// 							updated_at: 1613652517,
			// 							closed_at: null,
			// 							closest_task_at: null,
			// 							is_deleted: false,
			// 							custom_fields_values: null,
			// 							score: null,
			// 							account_id: 29305399,
			// 							_links: { self: [Object] },
			// 							_embedded: { tags: [], companies: [] }
			// 						},
			// 						{
			// 							id: 1593813,
			// 							name: 'Продвижение',
			// 							price: 325678,
			// 							responsible_user_id: 6766063,
			// 							group_id: 0,
			// 							status_id: 38046913,
			// 							pipeline_id: 3998857,
			// 							loss_reason_id: null,
			// 							created_by: 6766063,
			// 							updated_by: 6766063,
			// 							created_at: 1613652621,
			// 							updated_at: 1613652621,
			// 							closed_at: null,
			// 							closest_task_at: null,
			// 							is_deleted: false,
			// 							custom_fields_values: null,
			// 							score: null,
			// 							account_id: 29305399,
			// 							_links: { self: [Object] },
			// 							_embedded: { tags: [], companies: [] }
			// 						},
			// 						{
			// 							id: 1593885,
			// 							name: 'Подключение сервиса',
			// 							price: 564648,
			// 							responsible_user_id: 6766063,
			// 							group_id: 0,
			// 							status_id: 38046916,
			// 							pipeline_id: 3998857,
			// 							loss_reason_id: null,
			// 							created_by: 6766063,
			// 							updated_by: 6766063,
			// 							created_at: 1613652711,
			// 							updated_at: 1613652725,
			// 							closed_at: null,
			// 							closest_task_at: null,
			// 							is_deleted: false,
			// 							custom_fields_values: null,
			// 							score: null,
			// 							account_id: 29305399,
			// 							_links: { self: [Object] },
			// 							_embedded: { tags: [], companies: [] }
			// 						},
			// 						{
			// 							id: 1593943,
			// 							name: 'Продвижение',
			// 							price: 1000000,
			// 							responsible_user_id: 6766063,
			// 							group_id: 0,
			// 							status_id: 38046919,
			// 							pipeline_id: 3998857,
			// 							loss_reason_id: null,
			// 							created_by: 6766063,
			// 							updated_by: 6766063,
			// 							created_at: 1613652777,
			// 							updated_at: 1613652780,
			// 							closed_at: null,
			// 							closest_task_at: null,
			// 							is_deleted: false,
			// 							custom_fields_values: null,
			// 							score: null,
			// 							account_id: 29305399,
			// 							_links: { self: [Object] },
			// 							_embedded: { tags: [], companies: [] }
			// 						}
			// 					]
			
			if (leads.length) {
				leads.forEach((lead, i) => {			
					let row = document.createElement('tr')
					row.className = 'row'
					row.id = `${i}`
					let name = lead.name
					let status = lead.status_id
					let spanColor = ""
						switch (status) {
							case 38046913:
								status = 'ПЕРВИЧНЫЙ КОНТАКТ'
								spanColor = "background-color: rgb(153, 204, 255)"
								break
							case 38046916:
								status = 'ПЕРЕГОВОРЫ'
								spanColor = "background-color: rgb(255, 255, 153)"
								break
							case 38046919:
								status = 'ПРИНИМАЮТ РЕШЕНИЕ'
								spanColor = "background-color: rgb(255, 204, 102)"
								break
							default:
								status = 'СОГЛАСОВАНИЕ ДОГОВОРА'
								spanColor = "background-color: #F44336"
								break
						} 
					let person = lead.responsible_user_id
						switch (person) {
							case 6766063:
								person = "Тулев Андрей"
								break
						}
					let create = new Date(lead.created_at * 1000)
						let day = create.getDate()
						let months = ['Января','Февраля','Марта','Апреля','Майя','Июня','Июля','Августа','Сентября','Октября','Ноября','Декабря']
						let month = months[create.getMonth()]
						let year = create.getFullYear()
						
					let prise = lead.price.toLocaleString('ru') + " ₽"
					row.innerHTML = `<th class="name">${name}</th>
									<th class="status"><span class="span" style="${spanColor}">${status}</span></th>
									<th class="person"><span class="ant-avatar ant-avatar-circle ant-avatar-icon" style="width: 25px; height: 25px; line-height: 25px; font-size: 12.5px; margin-right: 8px;"><i aria-label="icon: user" class="anticon anticon-user"><svg viewBox="64 64 896 896" data-icon="user" width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><path d="M858.5 763.6a374 374 0 0 0-80.6-119.5 375.63 375.63 0 0 0-119.5-80.6c-.4-.2-.8-.3-1.2-.5C719.5 518 760 444.7 760 362c0-137-111-248-248-248S264 225 264 362c0 82.7 40.5 156 102.8 201.1-.4.2-.8.3-1.2.5-44.8 18.9-85 46-119.5 80.6a375.63 375.63 0 0 0-80.6 119.5A371.7 371.7 0 0 0 136 901.8a8 8 0 0 0 8 8.2h60c4.4 0 7.9-3.5 8-7.8 2-77.2 33-149.5 87.8-204.3 56.7-56.7 132-87.9 212.2-87.9s155.5 31.2 212.2 87.9C779 752.7 810 825 812 902.2c.1 4.4 3.6 7.8 8 7.8h60a8 8 0 0 0 8-8.2c-1-47.8-10.9-94.3-29.5-138.2zM512 534c-45.9 0-89.1-17.9-121.6-50.4S340 407.9 340 362c0-45.9 17.9-89.1 50.4-121.6S466.1 190 512 190s89.1 17.9 121.6 50.4S684 316.1 684 362c0 45.9-17.9 89.1-50.4 121.6S557.9 534 512 534z"></path></svg></i></span>${person}</th>
									<th class="create">${day} ${month} ${year}</th>
									<th class="prise">${prise}</th>`
					document.querySelector('.tbody').appendChild(row)
				})
			}
			
			const responseContacts = await fetch('http://localhost:5000/contacts')
			const contacts = await responseContacts.json()
			// const contacts = [
			// 					{
			// 						id: 2485661,
			// 						name: 'Карина Игнатова',
			// 						first_name: 'Карина',
			// 						last_name: 'Игнатова',
			// 						responsible_user_id: 6766063,
			// 						group_id: 0,
			// 						created_by: 6766063,
			// 						updated_by: 6766063,
			// 						created_at: 1613652307,
			// 						updated_at: 1613652307,
			// 						closest_task_at: null,
			// 						is_deleted: false,
			// 						custom_fields_values: [ 
			// 							{
			// 								field_code: "PHONE",
			// 								field_id: 461473,
			// 								field_name: "Телефон",
			// 								field_type: "multitext",
			// 								values: ["Телефон"],
			// 								__proto__: Object
			// 							},
			// 							{
			// 								field_code: "EMAIL",
			// 								field_id: 461475,
			// 								field_name: "Email",
			// 								field_type: "multitext",
			// 								values: ["Email"],
			// 								__proto__: Object
			// 							}
			// 						],
			// 						account_id: 29305399,
			// 						_links: { self: [Object] },
			// 						_embedded: { tags: [], companies: [] }
			// 					},
			// 					{
			// 						id: 2485707,
			// 						name: 'Иван Иванович',
			// 						first_name: 'Иван',
			// 						last_name: 'Иванович',
			// 						responsible_user_id: 6766063,
			// 						group_id: 0,
			// 						created_by: 6766063,
			// 						updated_by: 6766063,
			// 						created_at: 1613652354,
			// 						updated_at: 1613652354,
			// 						closest_task_at: null,
			// 						is_deleted: false,
			// 						custom_fields_values: [ 
			// 							{
			// 								field_code: "PHONE",
			// 								field_id: 461473,
			// 								field_name: "Телефон",
			// 								field_type: "multitext",
			// 								values: ["Телефон"],
			// 								__proto__: Object
			// 							},
			// 							{
			// 								field_code: "EMAIL",
			// 								field_id: 461475,
			// 								field_name: "Email",
			// 								field_type: "multitext",
			// 								values: ["Email"],
			// 								__proto__: Object
			// 							}
			// 						],
			// 						account_id: 29305399,
			// 						_links: { self: [Object] },
			// 						_embedded: { tags: [], companies: [] }
			// 					},
			// 					{
			// 						id: 2485751,
			// 						name: 'Андрей Андреевич',
			// 						first_name: 'Андрей',
			// 						last_name: 'Андреевич',
			// 						responsible_user_id: 6766063,
			// 						group_id: 0,
			// 						created_by: 6766063,
			// 						updated_by: 6766063,
			// 						created_at: 1613652416,
			// 						updated_at: 1613652416,
			// 						closest_task_at: null,
			// 						is_deleted: false,
			// 						custom_fields_values: [ 
			// 							{
			// 								field_code: "PHONE",
			// 								field_id: 461473,
			// 								field_name: "Телефон",
			// 								field_type: "multitext",
			// 								values: ["Телефон"],
			// 								__proto__: Object
			// 							},
			// 							{
			// 								field_code: "EMAIL",
			// 								field_id: 461475,
			// 								field_name: "Email",
			// 								field_type: "multitext",
			// 								values: ["Email"],
			// 								__proto__: Object
			// 							}
			// 						],
			// 						account_id: 29305399,
			// 						_links: { self: [Object] },
			// 						_embedded: { tags: [], companies: [] }
			// 					},
			// 					{
			// 						id: 2485859,
			// 						name: 'Александр Александрович',
			// 						first_name: 'Александр',
			// 						last_name: 'Александрович',
			// 						responsible_user_id: 6766063,
			// 						group_id: 0,
			// 						created_by: 6766063,
			// 						updated_by: 6766063,
			// 						created_at: 1613652517,
			// 						updated_at: 1613652517,
			// 						closest_task_at: null,
			// 						is_deleted: false,
			// 						custom_fields_values: [ 
			// 							{
			// 								field_code: "PHONE",
			// 								field_id: 461473,
			// 								field_name: "Телефон",
			// 								field_type: "multitext",
			// 								values: ["Телефон"],
			// 								__proto__: Object
			// 							},
			// 							{
			// 								field_code: "EMAIL",
			// 								field_id: 461475,
			// 								field_name: "Email",
			// 								field_type: "multitext",
			// 								values: ["Email"],
			// 								__proto__: Object
			// 							}
			// 						],
			// 						account_id: 29305399,
			// 						_links: { self: [Object] },
			// 						_embedded: { tags: [], companies: [] }
			// 					},
			// 					{
			// 						id: 2485927,
			// 						name: 'Тимур Тимурович',
			// 						first_name: 'Тимур',
			// 						last_name: 'Тимурович',
			// 						responsible_user_id: 6766063,
			// 						group_id: 0,
			// 						created_by: 6766063,
			// 						updated_by: 6766063,
			// 						created_at: 1613652621,
			// 						updated_at: 1613652621,
			// 						closest_task_at: null,
			// 						is_deleted: false,
			// 						custom_fields_values: [ 
			// 							{
			// 								field_code: "PHONE",
			// 								field_id: 461473,
			// 								field_name: "Телефон",
			// 								field_type: "multitext",
			// 								values: ["Телефон"],
			// 								__proto__: Object
			// 							},
			// 							{
			// 								field_code: "EMAIL",
			// 								field_id: 461475,
			// 								field_name: "Email",
			// 								field_type: "multitext",
			// 								values: ["Email"],
			// 								__proto__: Object
			// 							}
			// 						],
			// 						account_id: 29305399,
			// 						_links: { self: [Object] },
			// 						_embedded: { tags: [], companies: [] }
			// 					},
			// 					{
			// 						id: 2486069,
			// 						name: 'Антон Антонович',
			// 						first_name: 'Антон',
			// 						last_name: 'Антонович',
			// 						responsible_user_id: 6766063,
			// 						group_id: 0,
			// 						created_by: 6766063,
			// 						updated_by: 6766063,
			// 						created_at: 1613652711,
			// 						updated_at: 1613652711,
			// 						closest_task_at: null,
			// 						is_deleted: false,
			// 						custom_fields_values: [ 
			// 							{
			// 								field_code: "PHONE",
			// 								field_id: 461473,
			// 								field_name: "Телефон",
			// 								field_type: "multitext",
			// 								values: ["Телефон"],
			// 								__proto__: Object
			// 							},
			// 							{
			// 								field_code: "EMAIL",
			// 								field_id: 461475,
			// 								field_name: "Email",
			// 								field_type: "multitext",
			// 								values: ["Email"],
			// 								__proto__: Object
			// 							}
			// 						],
			// 						account_id: 29305399,
			// 						_links: { self: [Object] },
			// 						_embedded: { tags: [], companies: [] }
			// 					},
			// 					{
			// 						id: 2488279,
			// 						name: 'Игнат Игнатович',
			// 						first_name: 'Игнат',
			// 						last_name: 'Игнатович',
			// 						responsible_user_id: 6766063,
			// 						group_id: 0,
			// 						created_by: 6766063,
			// 						updated_by: 6766063,
			// 						created_at: 1613652777,
			// 						updated_at: 1613652777,
			// 						closest_task_at: null,
			// 						is_deleted: false,
			// 						custom_fields_values: [ 
			// 							{
			// 								field_code: "PHONE",
			// 								field_id: 461473,
			// 								field_name: "Телефон",
			// 								field_type: "multitext",
			// 								values: ["Телефон"],
			// 								__proto__: Object
			// 							},
			// 							{
			// 								field_code: "EMAIL",
			// 								field_id: 461475,
			// 								field_name: "Email",
			// 								field_type: "multitext",
			// 								values: ["Email"],
			// 								__proto__: Object
			// 							}
			// 						],
			// 						account_id: 29305399,
			// 						_links: { self: [Object] },
			// 						_embedded: { tags: [], companies: [] }
			// 					}
			// 				]
			
			if (contacts.length) {
				contacts.forEach((contact, i) => {
					contact.custom_fields_values.forEach(phoneEmail => {
						if (phoneEmail.field_name == 'Телефон') {
							phone = phoneEmail.values[0].value
						}
						if (phoneEmail.field_name == 'Email') {
							email = phoneEmail.values[0].value
						}
					})
					let rowContact = document.createElement('tr')
					rowContact.className = `rowContact ${i}`
					rowContact.style = 'display: none;'
					rowContact.innerHTML = `<th class="name">${contact.name} ${phone} ${email}</th>
									<th class="status"></th>
									<th class="person"></th>
									<th class="create"></th>
									<th class="prise"></th>`
					
					document.querySelectorAll('.row')[i].after(rowContact)
				})
			}
		
			const search = document.querySelector('.search')
			search.oninput = async () => {
				if (search.value.length >= 3) {
					const sendQuery = await fetch(`http://localhost:5000/search?query=${search.value}`)
					const queryLeads = await sendQuery.json()
					console.log(queryLeads)
					if (queryLeads) {		
						document.querySelector('.tbody').innerHTML = ''
						queryLeads.forEach(lead => {			
							let row = document.createElement('tr')
							row.className = 'row'
							let name = lead.name
							let status = lead.status_id
							let person = lead.responsible_user_id
							let create = lead.created_at
							let prise = lead.price
							row.innerHTML = `<th class="name">${name}</th>
											<th class="status">${status}</th>
											<th class="person">${person}</th>
											<th class="create">${create}</th>
											<th class="prise">${prise}</th>`
							document.querySelector('.tbody').appendChild(row)
						})
					}
				}
			}
			
			const rowClick = document.querySelectorAll('.row')
			for (let i = 0; i < rowClick.length; i++) {
				rowClick[i].onclick = function(e) {
					let rowClickID = document.getElementsByClassName(this.id)[0]
					rowClickID.style.display == 'none' ? rowClickID.style.display = 'contents' : rowClickID.style.display = 'none'
				};
			}
			
		})();

		// fetch('http://localhost:5000/')
		// 	.then(response => response.json())
		// 	.then(json => console.log(json))
		// 	.then(json => 
		// 		for (key in json) {
		// 			console.log(key.name)
		// 		}
		// 	)
    </script>
</body>
</html>